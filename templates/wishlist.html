{% extends "base.html" %}
{% block content %}
<h2>{{ team.name }}'s Wishlist</h2>
<p>Owner: {{ team.owner }}</p>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start;">
    <!-- Left Column: Wishlist -->
    <div>
        <h3>My Wishlist (Drag to Reorder)</h3>

        <!-- Scrollable wishlist -->
        <div id="wishlist" style="
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            min-height: 200px;
            max-height: 600px;
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid #ddd;
        ">
            {% if wishlist %}
                {% for item in wishlist %}
                <div class="wishlist-item" data-player-id="{{ item.player.id }}"
                     style="background: white; padding: 10px; margin: 5px 0; border-radius: 4px; cursor: move; border: 1px solid #ddd;
                            {% if item.player.status and item.player.status != 'Available' %}
                                {% if 'injured' in item.player.status|lower or 'doubtful' in item.player.status|lower %}
                                    background-color: #ffebee; border-left: 4px solid #d32f2f;
                                {% elif 'suspended' in item.player.status|lower %}
                                    background-color: #fff3e0; border-left: 4px solid #ff9800;
                                {% elif 'transfer' in item.player.status|lower %}
                                    background-color: #e3f2fd; border-left: 4px solid #2196F3;
                                {% endif %}
                            {% endif %}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <strong>#{{ item.rank }}. {{ item.player.name }}</strong>
                            <span class="position-badge position-{{ item.player.position }}">{{ item.player.position }}</span>
                            <span style="color: #666;">{{ item.player.team }}</span>

                            {% if item.player.drafted %}
                                <span style="color: red; font-weight: bold;">[DRAFTED]</span>
                            {% endif %}

                            {% if item.player.status and item.player.status != 'Available' %}
                                {% if 'injured' in item.player.status|lower or 'doubtful' in item.player.status|lower %}
                                    <span style="color: #d32f2f; font-size: 11px;">üöë</span>
                                {% elif 'suspended' in item.player.status|lower %}
                                    <span style="color: #ff9800; font-size: 11px;">‚ö†Ô∏è</span>
                                {% elif 'transfer' in item.player.status|lower %}
                                    <span style="color: #2196F3; font-size: 11px;">‚úàÔ∏è</span>
                                {% endif %}
                            {% endif %}

                            <div style="font-size: 12px; color: #666;">
                                {% if item.player.now_cost %}¬£{{ "%.1f"|format(item.player.now_cost) }}m | {% endif %}
                                Points: {{ item.player.total_points or 'N/A' }} |
                                PPG: {{ "%.1f"|format(item.player.points_per_game) if item.player.points_per_game else 'N/A' }}
                                {% if item.player.goals_scored or item.player.assists %}
                                    | G: {{ item.player.goals_scored or 0 }} A: {{ item.player.assists or 0 }}
                                {% endif %}
                            </div>

                            {% if item.player.status and item.player.status != 'Available' %}
                                <div style="font-size: 11px; color: {% if 'injured' in item.player.status|lower %}#d32f2f{% elif 'suspended' in item.player.status|lower %}#ff9800{% elif 'transfer' in item.player.status|lower %}#2196F3{% else %}#666{% endif %}; margin-top: 3px;">
                                    Status: {{ item.player.status }}
                                </div>
                            {% endif %}

                            {% if item.player.notes %}
                                <div style="font-size: 10px; color: #666; margin-top: 3px; font-style: italic;">
                                    üì∞ {{ item.player.notes }}
                                </div>
                            {% endif %}
                        </div>

                        <form method="POST" action="{{ url_for('remove_from_wishlist', team_id=team.id, player_id=item.player.id) }}" style="display: inline;">
                            <button type="submit" class="btn" style="background-color: #d32f2f; padding: 5px 10px; font-size: 12px;">√ó</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p style="color: #666; text-align: center; padding: 50px 0;">No players in wishlist yet</p>
            {% endif %}
        </div>

        <!-- Wishlist summary -->
        <div style="margin-top: 10px; padding: 8px; background-color: #f0f0f0; border-radius: 4px; font-size: 12px;">
            <div>
                {% set pos_counts = {} %}
                {% for item in wishlist if not item.player.drafted %}
                    {% set _ = pos_counts.update({item.player.position: pos_counts.get(item.player.position, 0) + 1}) %}
                {% endfor %}

                <strong>Position Summary:</strong>
                {% for pos in ['GK', 'DEF', 'MID', 'FWD'] %}
                    <span class="position-badge position-{{ pos }}" style="font-size: 11px;">{{ pos }}: {{ pos_counts.get(pos, 0) }}</span>
                {% endfor %}
            </div>
            <div style="margin-top: 5px;">
                <strong>Total:</strong> {{ wishlist|length }} players
                {% if wishlist|length > 0 %} | <strong>Top pick:</strong> {{ wishlist[0].player.name }}{% endif %}
            </div>
        </div>

        <!-- Compact tips -->
        <div style="margin-top: 10px; font-size: 11px; color: #666;">
            üí° Drag to reorder | Scroll to see all | #1 = highest priority | Hover for player details
        </div>
    </div>

    <!-- Right Column: Add Players -->
    <div>
        <h3>Add Players to Wishlist</h3>

        <!-- Enhanced Filter Controls -->
        <div style="background-color: #f5f5f5; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
            <!-- Search Box -->
            <div style="margin-bottom: 10px;">
                <input type="text"
                       id="playerSearch"
                       placeholder="üîç Search by player name..."
                       style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
            </div>

            <!-- Filter dropdowns -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <!-- Position Filter -->
                <div>
                    <label style="font-size: 11px;">Position:</label>
                    <select id="positionSelect" onchange="updateWishlistFilters()" style="width: 100%; padding: 3px; font-size: 12px;">
                        <option value="all" {% if current_position =='all' %}selected{% endif %}>All</option>
                        <option value="GK" {% if current_position =='GK' %}selected{% endif %}>GK</option>
                        <option value="DEF" {% if current_position =='DEF' %}selected{% endif %}>DEF</option>
                        <option value="MID" {% if current_position =='MID' %}selected{% endif %}>MID</option>
                        <option value="FWD" {% if current_position =='FWD' %}selected{% endif %}>FWD</option>
                    </select>
                </div>

                <!-- Team Filter -->
                <div>
                    <label style="font-size: 11px;">Team:</label>
                    <select id="teamSelect" onchange="updateWishlistFilters()" style="width: 100%; padding: 3px; font-size: 12px;">
                        <option value="all">All Teams</option>
                        {% set teams = available_players | map(attribute='team') | unique | sort %}
                        {% for team in teams %}
                            <option value="{{ team }}" {% if current_team_filter == team %}selected{% endif %}>{{ team }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Sort Dropdown -->
            <div style="margin-top: 5px;">
                <label style="font-size: 11px;">Sort by:</label>
                <select id="sortSelect" onchange="updateWishlistFilters()" style="width: 100%; padding: 3px; font-size: 12px;">
                    <option value="total_points" {% if current_sort =='total_points' %}selected{% endif %}>Total Points</option>
                    <option value="points_per_game" {% if current_sort =='points_per_game' %}selected{% endif %}>Points Per Game</option>
                    <option value="now_cost" {% if current_sort =='now_cost' %}selected{% endif %}>Price</option>
                    <option value="goals_scored" {% if current_sort =='goals_scored' %}selected{% endif %}>Goals</option>
                    <option value="assists" {% if current_sort =='assists' %}selected{% endif %}>Assists</option>
                    <option value="minutes" {% if current_sort =='minutes' %}selected{% endif %}>Minutes</option>
                    <option value="name" {% if current_sort =='name' %}selected{% endif %}>Name</option>
                </select>
            </div>

            <!-- Clear button -->
            <button onclick="clearWishlistFilters()" class="btn" style="margin-top: 5px; padding: 3px 8px; font-size: 11px; background-color: #666; width: 100%;">
                ‚úï Clear All Filters
            </button>
        </div>

        <!-- Player count -->
        <div style="font-size: 11px; color: #666; margin-bottom: 5px;">
            Showing <span id="visibleCount">{{ available_players|length }}</span> available players
        </div>

        <!-- Player List -->
        <div style="height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; position: relative;">
            {% for player in available_players %}
            <div class="player-option"
                 data-name="{{ player.name|lower }}"
                 data-team="{{ player.team|lower }}"
                 data-position="{{ player.position }}"
                 data-search="{{ (player.first_name ~ ' ' ~ player.second_name ~ ' ' ~ player.web_name)|lower }}"
                 style="background: #f9f9f9; padding: 8px; margin: 5px 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; position: relative;
                        {% if player.status and player.status != 'Available' %}
                            {% if 'injured' in player.status|lower or 'doubtful' in player.status|lower %}
                                background-color: #ffebee; border-left: 3px solid #d32f2f;
                            {% elif 'suspended' in player.status|lower %}
                                background-color: #fff3e0; border-left: 3px solid #ff9800;
                            {% elif 'transfer' in player.status|lower %}
                                background-color: #e3f2fd; border-left: 3px solid #2196F3;
                            {% endif %}
                        {% endif %}">

                <!-- Player Tooltip -->
                <div class="player-tooltip" style="display: none; position: fixed; background: #333; color: white; padding: 12px; border-radius: 5px; font-size: 12px; min-width: 300px; max-width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); pointer-events: none; z-index: 9999;">
                    <div style="font-size: 13px; font-weight: bold; margin-bottom: 5px;">
                        {{ player.full_name or player.name }}
                    </div>
                    <div style="color: #ffd700; margin-bottom: 5px; font-size: 11px;">
                        {{ player.team }} - {{ player.position }}
                    </div>

                    {% if player.status and player.status != 'Available' %}
                    <div style="margin-bottom: 5px;">
                        <span style="color: {% if 'injured' in player.status|lower %}#ff6b6b{% elif 'suspended' in player.status|lower %}#ffa726{% elif 'transfer' in player.status|lower %}#64b5f6{% else %}#66bb6a{% endif %}; font-size: 11px;">
                            Status: {{ player.status }}
                        </span>
                    </div>
                    {% endif %}

                    {% if player.notes %}
                    <div style="background-color: rgba(144, 202, 249, 0.1); padding: 5px; border-radius: 3px; margin: 5px 0; border-left: 3px solid #90caf9;">
                        <span style="color: #90caf9; font-weight: bold; font-size: 11px;">Notes:</span><br>
                        <span style="color: #fff; font-size: 10px; line-height: 1.4;">{{ player.notes }}</span>
                    </div>
                    {% endif %}

                    <hr style="margin: 6px 0; border-color: #555; border-style: solid; border-width: 1px 0 0 0;">

                    <div style="font-size: 10px; line-height: 1.5;">
                        <strong>{{ player.total_points or 0 }}</strong> pts |
                        <strong>{{ player.minutes or 0 }}</strong> mins |
                        {% if player.position in ['FWD', 'MID'] %}
                            G: <strong>{{ player.goals_scored or 0 }}</strong>
                            A: <strong>{{ player.assists or 0 }}</strong>
                        {% else %}
                            CS: <strong>{{ player.clean_sheets or 0 }}</strong>
                        {% endif %}
                        {% if player.now_cost %}
                            | ¬£<strong>{{ "%.1f"|format(player.now_cost) }}</strong>m
                        {% endif %}
                    </div>
                </div>

                <div style="flex: 1;" class="player-info-hover">
                    <strong>{{ player.name }}</strong>
                    <span class="position-badge position-{{ player.position }}">{{ player.position }}</span>
                    <span style="color: #666;">{{ player.team }}</span>

                    {% if player.status and player.status != 'Available' %}
                        {% if 'injured' in player.status|lower or 'doubtful' in player.status|lower %}
                            <span style="color: #d32f2f; font-size: 10px;">üöë</span>
                        {% elif 'suspended' in player.status|lower %}
                            <span style="color: #ff9800; font-size: 10px;">‚ö†Ô∏è</span>
                        {% elif 'transfer' in player.status|lower %}
                            <span style="color: #2196F3; font-size: 10px;">‚úàÔ∏è</span>
                        {% endif %}
                    {% endif %}

                    <div style="font-size: 11px; color: #666;">
                        {% if player.now_cost %}¬£{{ "%.1f"|format(player.now_cost) }}m | {% endif %}
                        Pts: {{ player.total_points or 0 }} |
                        PPG: {{ "%.1f"|format(player.points_per_game) if player.points_per_game else 'N/A' }}
                        {% if player.minutes %}| Min: {{ player.minutes }}{% endif %}
                        {% if player.goals_scored or player.assists %}
                            | G: {{ player.goals_scored or 0 }} A: {{ player.assists or 0 }}
                        {% endif %}
                    </div>
                </div>

                <form method="POST" action="{{ url_for('add_to_wishlist', team_id=team.id, player_id=player.id) }}" style="display: inline;">
                    <button type="submit" class="btn" style="padding: 5px 10px; font-size: 12px;">+</button>
                </form>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div style="margin-top: 20px;">
    <a href="{{ url_for('view_team', team_id=team.id) }}" class="btn">Back to Team</a>
    <a href="{{ url_for('draft') }}" class="btn">Back to Draft</a>
</div>

<!-- Replace the entire <script> section in wishlist.html with this fixed version -->

<script>
    // Update wishlist filters
    function updateWishlistFilters() {
        const sort = document.getElementById('sortSelect').value;
        const position = document.getElementById('positionSelect').value;
        const team = document.getElementById('teamSelect').value;
        window.location.href = `{{ url_for('team_wishlist', team_id=team.id) }}?sort=${sort}&position=${position}&team=${team}`;
    }

    // Clear filters
    function clearWishlistFilters() {
        window.location.href = `{{ url_for('team_wishlist', team_id=team.id) }}`;
    }

    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {

        // Enhanced search functionality
        const searchInput = document.getElementById('playerSearch');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const players = document.querySelectorAll('.player-option');
                let visibleCount = 0;

                players.forEach(player => {
                    const searchData = player.dataset.search;
                    const match = !searchTerm || searchData.includes(searchTerm);

                    if (match) {
                        player.style.display = 'flex';
                        visibleCount++;
                    } else {
                        player.style.display = 'none';
                    }
                });

                document.getElementById('visibleCount').textContent = visibleCount;
            });
        }

        // Setup tooltips - SIMPLIFIED APPROACH
        const playerOptions = document.querySelectorAll('.player-option');

        playerOptions.forEach(function(playerCard) {
            const tooltip = playerCard.querySelector('.player-tooltip');
            const hoverArea = playerCard.querySelector('.player-info-hover');

            if (tooltip && hoverArea) {
                // Use mouseover/mouseout instead of mouseenter/mouseleave
                hoverArea.addEventListener('mouseover', function(e) {
                    e.stopPropagation();
                    const rect = playerCard.getBoundingClientRect();
                    const tooltipWidth = 350;
                    const tooltipHeight = 250;

                    // Calculate position
                    let left = rect.right + 10;
                    let top = rect.top;

                    // Adjust if would go off screen
                    if (left + tooltipWidth > window.innerWidth - 20) {
                        left = rect.left - tooltipWidth - 10;
                    }

                    if (top + tooltipHeight > window.innerHeight - 20) {
                        top = window.innerHeight - tooltipHeight - 20;
                    }

                    if (top < 20) {
                        top = 20;
                    }

                    // Apply position and show
                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                    tooltip.style.display = 'block';

                    // Debug log
                    console.log('Showing tooltip for:', hoverArea.querySelector('strong').textContent);
                });

                hoverArea.addEventListener('mouseout', function(e) {
                    e.stopPropagation();
                    tooltip.style.display = 'none';
                });

                // Also hide on parent mouseout as backup
                playerCard.addEventListener('mouseleave', function() {
                    tooltip.style.display = 'none';
                });
            }
        });

        // Drag and drop functionality for wishlist items
        let draggedElement = null;
        const wishlistItems = document.querySelectorAll('.wishlist-item');

        wishlistItems.forEach(function(item) {
            item.draggable = true;

            item.addEventListener('dragstart', function(e) {
                draggedElement = this;
                this.style.opacity = '0.5';
            });

            item.addEventListener('dragend', function(e) {
                this.style.opacity = '';
            });

            item.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderTop = '3px solid #38003c';
            });

            item.addEventListener('dragleave', function(e) {
                this.style.borderTop = '';
            });

            item.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderTop = '';

                if (this !== draggedElement && draggedElement) {
                    const wishlist = document.getElementById('wishlist');
                    wishlist.insertBefore(draggedElement, this);

                    // Update order in database
                    const items = document.querySelectorAll('.wishlist-item');
                    const newOrder = Array.from(items).map(item => parseInt(item.dataset.playerId));

                    fetch(`/team/{{ team.id }}/wishlist/reorder`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({order: newOrder})
                    });

                    // Update rank numbers
                    items.forEach((item, index) => {
                        const rankElement = item.querySelector('strong');
                        if (rankElement) {
                            rankElement.textContent = rankElement.textContent.replace(/^#\d+\./, `#${index + 1}.`);
                        }
                    });
                }
            });
        });

        // Update visual state of drafted players
        wishlistItems.forEach(function(item) {
            if (item.textContent.includes('[DRAFTED]')) {
                item.style.backgroundColor = '#ffebee';
                item.style.opacity = '0.6';
            }
        });

        // Debug: Log how many tooltips we found
        console.log('Found', playerOptions.length, 'player cards with tooltips');
    });
</script>

<style>
.player-option:hover {
    background-color: #e3f2fd !important;
    transform: translateX(2px);
    transition: all 0.2s;
}
.player-tooltip {
    pointer-events: none;
}
</style>

{% endblock %}